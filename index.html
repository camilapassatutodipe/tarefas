<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel Dipe ‚Äî Kanban + Di√°rio/Semanal (Local)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6f7fb;--txt:#121212;--mut:#e6e6ee;--soft:#fff;--dark:#111;--shadow:0 8px 30px rgba(0,0,0,.08)}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--dark);color:#fff;box-shadow:var(--shadow);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .badge{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#ff6b5f;font-weight:800}
  .grow{flex:1}
  .btn{appearance:none;border:1px solid #bdbdbd;background:#fff;color:#111;border-radius:12px;padding:9px 12px;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(.98)} .btn.secondary{background:#111;color:#fff;border-color:#111}
  .btn.ghost{background:#fff;color:#111;border-color:#bdbdbd}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--mut);border-radius:10px;background:#fff;color:#111}
  .filters{display:grid;grid-template-columns:1fr 180px 160px 160px 180px auto;gap:10px;align-items:end;margin:14px 0}
  .filters label{font-size:12px;opacity:.8;margin-left:6px}
  .board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .col{background:var(--soft);border-radius:16px;box-shadow:var(--shadow)}
  .col h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--mut);display:flex;gap:8px;align-items:center}
  .list{padding:12px;min-height:260px}
  .card{background:#fff;border:1px solid var(--mut);border-radius:12px;padding:10px;margin:0 0 10px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
  .row{display:flex;gap:8px;align-items:center}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);margin-top:16px}
  th,td{padding:10px;border-bottom:1px solid var(--mut);text-align:left;font-size:14px}
  .panel{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .hidden{display:none!important}
  @media (max-width:980px){.filters{grid-template-columns:1fr 1fr 1fr}}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brand">
      <div class="badge">D</div>
      <div><div style="font-weight:800">Ag√™ncia Dipe</div><small>Painel de tarefas</small></div>
    </div>
    <div class="grow"></div>
    <button class="btn secondary" id="btnNew">+ Nova tarefa</button>
    <button class="btn" id="btnExportCsv">Exportar CSV</button>
    <button class="btn" id="btnExportJson">Backup JSON</button>
    <label class="btn ghost">Importar JSON<input type="file" id="importJson" accept="application/json" style="display:none"></label>
    <button class="btn ghost" id="btnClients">Clientes</button>
    <button class="btn ghost" id="btnCollabs">Colaboradores</button>
    <button class="btn" id="btnPrint">Imprimir</button>
  </div>
</header>

<section class="container">
  <!-- Filtros -->
  <div class="filters">
    <div><label for="q">üîé Pesquisar</label><input id="q" placeholder="t√≠tulo ou descri√ß√£o"></div>
    <div><label for="filterClient">üè¢ Cliente</label><select id="filterClient"><option value="">Todos</option></select></div>
    <div><label for="filterCollab">üë§ Colaborador</label><select id="filterCollab"><option value="">Todos</option></select></div>
    <div><label for="filterStatus">üè∑Ô∏è Status</label>
      <select id="filterStatus"><option value="">Todos</option><option>A Fazer</option><option>Em Progresso</option><option>Conclu√≠do</option><option>Backlog</option></select>
    </div>
    <div>
      <label for="viewMode">üëÅÔ∏è Vis√£o</label>
      <select id="viewMode">
        <option value="geral">Geral (Kanban)</option>
        <option value="diario">Di√°rio</option>
        <option value="semanal">Semanal</option>
      </select>
      <div id="dateWrap" class="row" style="margin-top:6px">
        <input id="dateDaily" type="date" class="" />
      </div>
    </div>
    <div style="align-self:end"><button class="btn ghost" id="btnClear">Limpar</button></div>
  </div>

  <!-- Board -->
  <div class="board" id="board">
    <div class="col" data-status="A Fazer"><h3>üóÇÔ∏è A Fazer</h3><div class="list"></div></div>
    <div class="col" data-status="Em Progresso"><h3>‚öôÔ∏è Em Progresso</h3><div class="list"></div></div>
    <div class="col" data-status="Conclu√≠do"><h3>‚úÖ Conclu√≠do</h3><div class="list"></div></div>
  </div>

  <!-- Entregas (tabela geral) -->
  <table id="tbl">
    <thead><tr><th>Tarefa</th><th>Cliente</th><th>Colaboradores</th><th>Status</th><th>Data</th><th>Atualizado</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- MODAL TAREFA -->
<template id="tplTaskModal">
  <div class="panel" style="width:min(640px,94vw)">
    <h3 id="taskTitle" style="margin:0 0 8px">Nova tarefa</h3>
    <div class="row" style="gap:10px">
      <div style="flex:1"><label>T√≠tulo</label><input id="t_title"></div>
      <div style="width:200px"><label>Cliente</label><select id="t_client"></select></div>
      <div style="width:200px"><label>Status</label>
        <select id="t_status"><option>A Fazer</option><option>Em Progresso</option><option>Conclu√≠do</option><option>Backlog</option></select>
      </div>
    </div>
    <div class="row" style="gap:10px;margin-top:10px">
      <div style="width:180px"><label>Data</label><input id="t_date" type="date"></div>
      <div class="grow"><label>Colaboradores (separe por v√≠rgula)</label><input id="t_collabs" list="dlCollabs"><datalist id="dlCollabs"></datalist></div>
    </div>
    <div style="margin-top:10px"><label>Descri√ß√£o</label><textarea id="t_desc" rows="4"></textarea></div>
    <div class="row" style="justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" id="btnDel">Excluir</button>
      <button class="btn" id="btnSave">Salvar</button>
    </div>
  </div>
</template>

<!-- MODAL CLIENTES -->
<template id="tplClients">
  <div class="panel" style="width:min(520px,94vw)">
    <h3 style="margin:0 0 8px">Clientes</h3>
    <div id="clientsList" class="grid" style="gap:8px"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button class="btn ghost" id="btnAddClient">+ Adicionar</button>
      <button class="btn" id="btnSaveClients">Salvar</button>
    </div>
  </div>
</template>

<!-- MODAL COLABS -->
<template id="tplCollabs">
  <div class="panel" style="width:min(520px,94vw)">
    <h3 style="margin:0 0 8px">Colaboradores</h3>
    <div id="collabsList" class="grid" style="gap:8px"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px">
      <button class="btn ghost" id="btnAddCollab">+ Adicionar</button>
      <button class="btn" id="btnSaveCollabs">Salvar</button>
    </div>
  </div>
</template>

<script>
/* ====== Estado/Persist√™ncia ====== */
const LS_TASKS = 'dipe_tasks_v1';
const LS_CLIENTS = 'dipe_clients_v1';
const LS_COLLABS = 'dipe_collabs_v1';

let tasks = JSON.parse(localStorage.getItem(LS_TASKS) || '[]');
let clients = JSON.parse(localStorage.getItem(LS_CLIENTS) || 'null') || [
  {name:'Matec',       color:'#02d1ce', text:'#0a0a0a'},  // azul piscina
  {name:'Costrucione', color:'#000000', text:'#ffffff'},  // preto
  {name:'Vertticom',   color:'#d67a59', text:'#ffffff'},  // terracota
  {name:'LRocha',      color:'#7b1e2b', text:'#ffffff'}   // vermelho vinho
];
let collabs = JSON.parse(localStorage.getItem(LS_COLLABS) || 'null') || ['Camila','Alinne'];
function saveAll(){ localStorage.setItem(LS_TASKS, JSON.stringify(tasks)); localStorage.setItem(LS_CLIENTS, JSON.stringify(clients)); localStorage.setItem(LS_COLLABS, JSON.stringify(collabs)); }

/* ====== Helpers ====== */
const $ = (s)=>document.querySelector(s);
const uid = ()=> (crypto.randomUUID? crypto.randomUUID(): (Date.now()+Math.random()).toString(16));
function fmtDate(d){ if(!d) return ''; const p=d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
function contrast(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16); const yiq=((r*299)+(g*587)+(b*114))/1000; return yiq>=128?'#0a0a0a':'#ffffff'; }catch(e){ return '#111'; } }
function clientTag(name){ const c=clients.find(x=>x.name===name)||{color:'#ddd',text:'#111'}; return `<span class="tag" style="background:${c.color};color:${c.text}">${name}</span>`; }
function sameWeek(d1, d2){ // compara segunda-domingo baseado em d2
  if(!d1||!d2) return false;
  const a=new Date(d1), b=new Date(d2);
  const day=(x)=>{ const d=new Date(x); d.setHours(0,0,0,0); const wd=(d.getDay()+6)%7; d.setDate(d.getDate()-wd); return d; }; // segunda
  const startA=day(a), startB=day(b);
  return startA.getTime()===startB.getTime();
}

/* ====== UI Init ====== */
function buildFilters(){
  $('#filterClient').innerHTML = '<option value="">Todos</option>'+clients.map(c=>`<option>${c.name}</option>`).join('');
  $('#filterCollab').innerHTML = '<option value="">Todos</option>'+Array.from(new Set(collabs)).map(c=>`<option>${c}</option>`).join('');
  $('#dlCollabs').innerHTML = Array.from(new Set(collabs)).map(c=>`<option value="${c}"></option>`).join('');
}
function filtered(){
  const q=($('#q').value||'').toLowerCase().trim();
  const fc=$('#filterClient').value, fco=$('#filterCollab').value, fs=$('#filterStatus').value;
  const mode=$('#viewMode').value, d=$('#dateDaily').value;
  return tasks.filter(t=>{
    const mQ=!q || (t.title+t.desc).toLowerCase().includes(q);
    const mC=!fc || t.client===fc;
    const mCo=!fco || (t.collabs||[]).includes(fco);
    const mS=!fs || t.status===fs;
    let mTime=true;
    if(mode==='diario' && d){ mTime = (t.date||'')===d; }
    if(mode==='semanal' && d){ mTime = sameWeek(t.date, d); }
    return mQ&&mC&&mCo&&mS&&mTime;
  });
}
function render(){
  const arr=filtered().slice().sort((a,b)=>(a.status>b.status?1:-1));
  // board
  const todo=$('[data-status="A Fazer"] .list'), doing=$('[data-status="Em Progresso"] .list'), done=$('[data-status="Conclu√≠do"] .list');
  todo.innerHTML=doing.innerHTML=done.innerHTML='';
  for(const t of arr){
    if(t.status==='Backlog') continue;
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="row"><strong style="flex:1">${t.title}</strong>${clientTag(t.client)}</div>
      <div style="font-size:12px;opacity:.85;margin-top:6px">${(t.collabs||[]).join(', ')}</div>
      ${t.date?`<div style="font-size:12px;opacity:.7;margin-top:4px">${fmtDate(t.date)}</div>`:''}
      <div class="row" style="justify-content:flex-end;margin-top:8px;gap:8px">
        <select data-act="status">
          <option ${t.status==='A Fazer'?'selected':''}>A Fazer</option>
          <option ${t.status==='Em Progresso'?'selected':''}>Em Progresso</option>
          <option ${t.status==='Conclu√≠do'?'selected':''}>Conclu√≠do</option>
          <option ${t.status==='Backlog'?'selected':''}>Backlog</option>
        </select>
        <button class="btn ghost" data-act="edit">Editar</button>
      </div>`;
    el.querySelector('[data-act="edit"]').onclick=()=> openTask(t);
    el.querySelector('[data-act="status"]').onchange=(e)=>{ t.status=e.target.value; t.updated=new Date().toISOString(); saveAll(); render(); };
    if(t.status==='A Fazer') todo.appendChild(el); else if(t.status==='Em Progresso') doing.appendChild(el); else done.appendChild(el);
  }
  // tabela entregas
  const tb=$('#tbl tbody'); tb.innerHTML='';
  for(const t of filtered().slice().sort((a,b)=> (a.date||'').localeCompare(b.date||''))){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${t.title}</strong><div style="opacity:.7;font-size:12px">${t.desc||''}</div></td>
      <td>${clientTag(t.client)}</td>
      <td>${(t.collabs||[]).join(', ')}</td>
      <td>${t.status}</td>
      <td>${fmtDate(t.date||'')}</td>
      <td>${new Date(t.updated||Date.now()).toLocaleString('pt-BR')}</td>
      <td><button class="btn ghost" data-edit="${t.id}">Editar</button></td>`;
    tb.appendChild(tr);
    tr.querySelector('[data-edit]').onclick=()=> openTask(tasks.find(x=>x.id===t.id));
  }
}

/* ====== Modais ====== */
function openTask(t){
  const tpl=$('#tplTaskModal').content.cloneNode(true); const panel=tpl.querySelector('.panel');
  const wrap=document.createElement('section'); wrap.style='position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:50'; wrap.appendChild(panel); document.body.appendChild(wrap);
  panel.querySelector('#taskTitle').textContent=t?'Editar tarefa':'Nova tarefa';
  const sel=panel.querySelector('#t_client'); sel.innerHTML=clients.map(c=>`<option ${t&&t.client===c.name?'selected':''}>${c.name}</option>`).join('');
  panel.querySelector('#t_title').value=t?.title||'';
  panel.querySelector('#t_status').value=t?.status||'A Fazer';
  panel.querySelector('#t_date').value=t?.date||'';
  panel.querySelector('#t_collabs').value=(t?.collabs||[]).join(', ');
  panel.querySelector('#t_desc').value=t?.desc||'';
  panel.querySelector('#btnDel').style.display=t?'inline-flex':'none';
  wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
  panel.querySelector('#btnSave').onclick=()=>{
    const payload={
      id: t?.id || uid(),
      title: panel.querySelector('#t_title').value.trim()||'Sem t√≠tulo',
      client: panel.querySelector('#t_client').value,
      status: panel.querySelector('#t_status').value,
      date: panel.querySelector('#t_date').value||null,
      collabs: panel.querySelector('#t_collabs').value.split(',').map(s=>s.trim()).filter(Boolean),
      desc: panel.querySelector('#t_desc').value.trim(),
      updated: new Date().toISOString()
    };
    const i=tasks.findIndex(x=>x.id===payload.id);
    if(i>=0) tasks[i]=payload; else tasks.unshift(payload);
    // atualiza sugest√µes de colaboradores
    payload.collabs.forEach(c=>{ if(c && !collabs.includes(c)) collabs.push(c); });
    saveAll(); buildFilters(); render(); wrap.remove();
  };
  panel.querySelector('#btnDel').onclick=()=>{ if(t && confirm('Excluir esta tarefa?')){ tasks = tasks.filter(x=>x.id!==t.id); saveAll(); render(); wrap.remove(); } };
}
function openClients(){
  const tpl=$('#tplClients').content.cloneNode(true); const panel=tpl.querySelector('.panel');
  const wrap=document.createElement('section'); wrap.style='position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:50'; wrap.appendChild(panel); document.body.appendChild(wrap);
  const list=panel.querySelector('#clientsList');
  function row(c){ const r=document.createElement('div'); r.className='row'; r.innerHTML=`<input placeholder="Nome" value="${c?.name||''}" style="flex:1"><input type="color" value="${c?.color||'#888888'}" style="width:100px"><button class="btn ghost">üóëÔ∏è</button>`; r.querySelector('button').onclick=()=> r.remove(); return r; }
  clients.forEach(c=> list.appendChild(row(c)));
  panel.querySelector('#btnAddClient').onclick=()=> list.appendChild(row({name:'',color:'#888888'}));
  panel.querySelector('#btnSaveClients').onclick=()=>{
    clients = Array.from(list.children).map(r=>{
      const name=r.querySelector('input[type="text"]').value.trim();
      const color=r.querySelector('input[type="color"]').value;
      if(!name) return null;
      const text=contrast(color);
      return {name,color,text};
    }).filter(Boolean);
    saveAll(); buildFilters(); render(); wrap.remove();
  };
  wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
}
function openCollabs(){
  const tpl=$('#tplCollabs').content.cloneNode(true); const panel=tpl.querySelector('.panel');
  const wrap=document.createElement('section'); wrap.style='position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:50'; wrap.appendChild(panel); document.body.appendChild(wrap);
  const list=panel.querySelector('#collabsList');
  function row(name){ const r=document.createElement('div'); r.className='row'; r.innerHTML=`<input placeholder="Nome do colaborador" value="${name||''}" style="flex:1"><button class="btn ghost">üóëÔ∏è</button>`; r.querySelector('button').onclick=()=> r.remove(); return r; }
  collabs.forEach(c=> list.appendChild(row(c)));
  panel.querySelector('#btnAddCollab').onclick=()=> list.appendChild(row(''));
  panel.querySelector('#btnSaveCollabs').onclick=()=>{
    collabs = Array.from(list.querySelectorAll('input[type="text"]')).map(i=>i.value.trim()).filter(Boolean);
    saveAll(); buildFilters(); render(); wrap.remove();
  };
  wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
}

/* ====== Actions ====== */
$('#btnNew').onclick=()=> openTask(null);
$('#btnClients').onclick=openClients;
$('#btnCollabs').onclick=openCollabs;
$('#btnPrint').onclick=()=> window.print();
$('#btnExportCsv').onclick=()=>{
  const arr=filtered();
  const head=['id','title','client','collabs','status','date','desc','updated'];
  const rows=[head.join(',')].concat(arr.map(t=>[
    t.id,t.title,t.client,(t.collabs||[]).join('|'),t.status,t.date,t.desc,t.updated
  ].map(x=>'"'+String(x??'').replaceAll('"','""')+'"').join(',')));
  const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tarefas.csv'; a.click();
};
$('#btnExportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(filtered(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tarefas.json'; a.click();
};
$('#importJson').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return; const text=await file.text(); let data=[]; try{data=JSON.parse(text);}catch(err){alert('JSON inv√°lido');return}
  if(!Array.isArray(data)){ alert('Esperado um array de tarefas'); return; }
  if(!confirm('Importar '+data.length+' tarefas?')) return;
  for(const x of data){
    tasks.push({ id: x.id||uid(), title:x.title||'Sem t√≠tulo', client:x.client||clients[0]?.name||'Cliente', status:x.status||'A Fazer', date:x.date||null, collabs:x.collabs||[], desc:x.desc||'', updated:x.updated||new Date().toISOString() });
  }
  saveAll(); render(); e.target.value='';
};
);
['q','filterClient','filterCollab','filterStatus','viewMode','dateDaily'].forEach(id=> document.getElementById(id).addEventListener('input', ()=>{
  // mostrador da data conforme modo
  const mode=$('#viewMode').value;
  $('#dateWrap').style.display = (mode==='diario'||mode==='semanal')? 'block':'none';
  render();
}));
$('#btnClear').onclick=()=>{ ['q','filterClient','filterCollab','filterStatus','dateDaily'].forEach(id=>{const el=document.getElementById(id); if(!el) return; el.value='';}); $('#viewMode').value='geral'; $('#dateWrap').style.display='none'; render(); };

/* ====== Start ====== */
buildFilters(); render();
</script>
</body>
</html>
