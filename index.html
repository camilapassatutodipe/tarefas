<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Dipe ‚Äî est√°vel (local)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f6f8; --text:#121212; --muted:#e6e6ea; --soft:#ffffff; --accent:#ff573b; --shadow:0 10px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    a{color:inherit}

    /* Header */
    header{position:sticky;top:0;background:#111;color:#fff;z-index:20;box-shadow:var(--shadow)}
    header .wrap{max-width:1220px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
    .brand{display:flex;gap:10px;align-items:center}
    .badge{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;background:#ff765f;color:#fff;font-weight:800}
    .grow{flex:1}

    /* Buttons com contraste alto */
    .btn{appearance:none;border:1px solid #bdbdbd;background:#fff;color:#111;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.04)}
    .btn:hover{filter:brightness(0.98)}
    .btn.secondary{background:#111;color:#fff;border-color:#111}
    .btn.secondary:hover{filter:brightness(1.1)}
    .btn.ghost{background:#fff;color:#111;border-color:#bdbdbd}
    .btn.ghost:hover{background:#f4f4f4}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    /* Layout principal */
    .container{max-width:1220px;margin:0 auto;padding:16px}
    .filters{display:grid;grid-template-columns:1fr 180px 180px 180px 180px auto;gap:10px;align-items:end;margin:16px 0}
    .filters label{font-size:12px;opacity:.8;margin-left:6px}
    input,select,textarea{background:#fff;color:#111;border:1px solid var(--muted);border-radius:12px;padding:10px}
    ::placeholder{color:#666}

    /* Board */
    .board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .col{background:var(--soft);border-radius:16px;box-shadow:var(--shadow)}
    .col h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--muted);display:flex;align-items:center;gap:8px}
    .list{padding:12px;min-height:260px}
    .card{background:#fff;border:1px solid var(--muted);border-radius:12px;padding:10px;margin:0 0 10px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px}
    .row{display:flex;gap:8px;align-items:center}

    /* Painel/Login */
    #login{min-height:100vh;display:grid;place-items:center;padding:24px}
    .panel{width:min(500px,92vw);background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .panel h1{margin:0 0 6px;font-size:20px}
    .panel small{opacity:.75}
    .panel .msg{font-size:12px;margin-top:8px;color:#b91c1c;min-height:16px}

    .hidden{display:none !important}

    @media (max-width:920px){.filters{grid-template-columns:1fr 1fr 1fr}}
  </style>
</head>
<body>
  <!-- LOGIN (senha simples) -->
  <section id="login" class="">
    <div class="panel">
      <div class="row" style="gap:10px">
        <div class="badge">D</div>
        <div>
          <h1>Ag√™ncia Dipe</h1>
          <small>Digite a senha para acessar</small>
        </div>
      </div>
      <div style="height:8px"></div>
      <label for="pass">Senha</label>
      <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div style="height:8px"></div>
      <button id="btnEnter" type="button" class="btn" style="width:100%">Entrar</button>
      <div class="msg" id="loginMsg"></div>
      <div style="height:8px"></div>
      <small>Se precisar trocar a senha, fale com a administra√ß√£o.</small>
    </div>
  </section>

  <!-- APP -->
  <header id="appHeader" class="hidden">
    <div class="wrap">
      <div class="brand">
        <div class="badge">D</div>
        <div>
          <div style="font-weight:800">Ag√™ncia Dipe</div>
          <small>Painel de tarefas</small>
        </div>
      </div>
      <div class="grow"></div>
      <button class="btn secondary" id="btnNew">+ Nova tarefa</button>
      <button class="btn" id="btnExportCsv">Exportar CSV</button>
      <button class="btn" id="btnExportJson">Backup JSON</button>
      <label class="btn ghost" title="Importar JSON">
        <input type="file" id="importJson" accept="application/json" style="display:none" />Importar
      </label>
      <button class="btn ghost" id="btnClients">Clientes</button>
      <button class="btn ghost" id="btnCollabs">Colaboradores</button>
      <button class="btn" id="btnPrint">Imprimir</button>
      <button class="btn ghost" id="btnLock">Bloquear</button>
    </div>
  </header>

  <section id="app" class="container hidden">
    <div class="filters">
      <div>
        <label for="q">üîé Pesquisar</label>
        <input id="q" placeholder="t√≠tulo ou descri√ß√£o" />
      </div>
      <div>
        <label for="fClient">üè¢ Cliente</label>
        <select id="fClient"><option value="">Todos</option></select>
      </div>
      <div>
        <label for="fCollab">üë§ Colaborador</label>
        <select id="fCollab"><option value="">Todos</option></select>
      </div>
      <div>
        <label for="fStatus">üè∑Ô∏è Status</label>
        <select id="fStatus">
          <option value="">Todos</option>
          <option>A Fazer</option>
          <option>Em Progresso</option>
          <option>Conclu√≠do</option>
          <option>Backlog</option>
        </select>
      </div>
      <div>
        <label for="fDate">üóìÔ∏è Data</label>
        <input id="fDate" type="date" />
      </div>
      <div style="align-self:end"><button class="btn ghost" id="btnClear">Limpar</button></div>
    </div>

    <div class="board" id="board">
      <div class="col" data-status="A Fazer"><h3>üóÇÔ∏è A Fazer</h3><div class="list"></div></div>
      <div class="col" data-status="Em Progresso"><h3>‚öôÔ∏è Em Progresso</h3><div class="list"></div></div>
      <div class="col" data-status="Conclu√≠do"><h3>‚úÖ Conclu√≠do</h3><div class="list"></div></div>
    </div>
  </section>

  <!-- MODAIS -->
  <template id="tplTaskModal">
    <div class="panel" style="width:min(640px,94vw)">
      <h1 id="taskTitle" style="font-size:18px;margin:0 0 8px">Nova tarefa</h1>
      <div class="row" style="gap:10px">
        <div style="flex:1">
          <label>T√≠tulo</label>
          <input id="t_title" />
        </div>
        <div style="width:200px">
          <label>Cliente</label>
          <select id="t_client"></select>
        </div>
        <div style="width:200px">
          <label>Status</label>
          <select id="t_status">
            <option>A Fazer</option>
            <option>Em Progresso</option>
            <option>Conclu√≠do</option>
            <option>Backlog</option>
          </select>
        </div>
      </div>
      <div class="row" style="gap:10px;margin-top:10px">
        <div style="width:180px">
          <label>Data</label>
          <input id="t_date" type="date" />
        </div>
        <div class="grow">
          <label>Colaboradores (separe por v√≠rgula)</label>
          <input id="t_collabs" list="dlCollabs" />
          <datalist id="dlCollabs"></datalist>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Descri√ß√£o</label>
        <textarea id="t_desc" rows="4"></textarea>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn ghost" id="btnDel">Excluir</button>
        <button class="btn" id="btnSave">Salvar</button>
      </div>
    </div>
  </template>

  <template id="tplClients">
    <div class="panel" style="width:min(520px,94vw)">
      <h1 style="font-size:18px;margin:0 0 8px">Clientes</h1>
      <div id="clientsList"></div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <button class="btn ghost" id="btnAddClient">+ Adicionar</button>
        <button class="btn" id="btnSaveClients">Salvar</button>
      </div>
    </div>
  </template>

  <template id="tplCollabs">
    <div class="panel" style="width:min(520px,94vw)">
      <h1 style="font-size:18px;margin:0 0 8px">Colaboradores</h1>
      <div id="collabsList"></div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <button class="btn ghost" id="btnAddCollab">+ Adicionar</button>
        <button class="btn" id="btnSaveCollabs">Salvar</button>
      </div>
    </div>
  </template>

  <script>
  // ===== CONFIG & ESTADO =====
  const PANEL_PASS = 'dipe2025!';
  const STORAGE_TASKS = 'dipe_tasks_v1';
  let tasks = [];
  let clients = JSON.parse(localStorage.getItem('dipe_clients')||'null') || [
    {name:'Matec',        color:'#02d1ce', text:'#0a0a0a'},
    {name:'Costrucione',  color:'#000000', text:'#ffffff'},
    {name:'Vertticom',    color:'#d67a59', text:'#ffffff'},
    {name:'LRocha',       color:'#7b1e2b', text:'#ffffff'}
  ];
  let collabs = JSON.parse(localStorage.getItem('dipe_collabs')||'null') || ['Camila','Alinne'];

  // ===== HELPERS =====
  const $  = (s)=> document.querySelector(s);
  const $$ = (s)=> Array.from(document.querySelectorAll(s));
  const uid = ()=> (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+Math.random()).toString(16));
  function csvEscape(s){return '"'+String(s??'').replaceAll('"','""')+'"'}
  function fmtDate(d){ if(!d) return ''; const p=d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
  function contrast(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16); const yiq=((r*299)+(g*587)+(b*114))/1000; return yiq>=128?'#0a0a0a':'#ffffff'; }catch(e){ return '#111'; } }
  function clientTag(name){ const c = clients.find(x=>x.name===name) || {color:'#ddd', text:'#111'}; return `<span class="tag" style="background:${c.color};color:${c.text}">${name}</span>`; }

  // ===== STORAGE local =====
  function persist(){ localStorage.setItem(STORAGE_TASKS, JSON.stringify(tasks)); }
  function load(){ try{ tasks = JSON.parse(localStorage.getItem(STORAGE_TASKS)||'[]'); }catch(e){ tasks=[]; } render(); buildFilters(); }

  // ===== RENDER =====
  function buildFilters(){
    $('#fClient').innerHTML = '<option value="">Todos</option>' + clients.map(c=>`<option>${c.name}</option>`).join('');
    $('#fCollab').innerHTML = '<option value="">Todos</option>' + Array.from(new Set(collabs)).map(c=>`<option>${c}</option>`).join('');
    $('#dlCollabs').innerHTML = Array.from(new Set(collabs)).map(c=>`<option value="${c}"></option>`).join('');
  }
  function filtered(){
    const q=$('#q').value.toLowerCase().trim(); const fc=$('#fClient').value; const fco=$('#fCollab').value; const fs=$('#fStatus').value; const fd=$('#fDate').value;
    return tasks.filter(t=>{
      const mQ=!q || (t.title+t.desc).toLowerCase().includes(q);
      const mC=!fc || t.client===fc; const mCo=!fco || (t.collabs||[]).includes(fco); const mS=!fs || t.status===fs; const mD=!fd || (t.date||'')===fd;
      return mQ&&mC&&mCo&&mS&&mD; });
  }
  function render(){
    const arr = filtered();
    const todo=$('[data-status="A Fazer"] .list'); const doing=$('[data-status="Em Progresso"] .list'); const done=$('[data-status="Conclu√≠do"] .list');
    todo.innerHTML = doing.innerHTML = done.innerHTML = '';
    for(const t of arr){
      if(t.status==='Backlog') continue; // backlog fora do board
      const el=document.createElement('div'); el.className='card';
      el.innerHTML = `
        <div class="row"><strong style="flex:1">${t.title}</strong>${clientTag(t.client)}</div>
        <div style="font-size:12px;opacity:.85;margin-top:6px">${(t.collabs||[]).join(', ')}</div>
        ${t.date?`<div style="font-size:12px;opacity:.7;margin-top:4px">${fmtDate(t.date)}</div>`:''}
        <div class="row" style="justify-content:flex-end;margin-top:8px;gap:8px">
          <select data-act="status">
            <option ${t.status==='A Fazer'?'selected':''}>A Fazer</option>
            <option ${t.status==='Em Progresso'?'selected':''}>Em Progresso</option>
            <option ${t.status==='Conclu√≠do'?'selected':''}>Conclu√≠do</option>
            <option ${t.status==='Backlog'?'selected':''}>Backlog</option>
          </select>
          <button class="btn ghost" data-act="edit">Editar</button>
        </div>`;
      el.querySelector('[data-act="edit"]').onclick=()=> openTask(t);
      el.querySelector('[data-act="status"]').onchange=(e)=>{ t.status=e.target.value; t.updated=new Date().toISOString(); persist(); render(); };
      if(t.status==='A Fazer') todo.appendChild(el); else if(t.status==='Em Progresso') doing.appendChild(el); else done.appendChild(el);
    }
  }

  // ===== MODAL TAREFA =====
  function openTask(t){
    const tpl=$('#tplTaskModal').content.cloneNode(true); const panel=tpl.querySelector('.panel');
    const wrap=document.createElement('section'); wrap.id='modal'; wrap.style='position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:50'; wrap.appendChild(panel); document.body.appendChild(wrap);
    panel.querySelector('#taskTitle').textContent = t? 'Editar tarefa':'Nova tarefa';
    const sel=panel.querySelector('#t_client'); sel.innerHTML = clients.map(c=>`<option ${t&&t.client===c.name?'selected':''}>${c.name}</option>`).join('');
    panel.querySelector('#t_title').value = t?.title||'';
    panel.querySelector('#t_status').value = t?.status||'A Fazer';
    panel.querySelector('#t_date').value = t?.date||'';
    panel.querySelector('#t_collabs').value = (t?.collabs||[]).join(', ');
    panel.querySelector('#t_desc').value = t?.desc||'';
    panel.querySelector('#btnDel').style.display = t? 'inline-flex':'none';

    wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
    panel.querySelector('#btnSave').onclick = ()=>{
      const payload={
        id: t?.id || uid(),
        title: panel.querySelector('#t_title').value.trim()||'Sem t√≠tulo',
        client: panel.querySelector('#t_client').value,
        status: panel.querySelector('#t_status').value,
        date: panel.querySelector('#t_date').value||null,
        collabs: panel.querySelector('#t_collabs').value.split(',').map(s=>s.trim()).filter(Boolean),
        desc: panel.querySelector('#t_desc').value.trim(),
        updated: new Date().toISOString()
      };
      if(t){ const i=tasks.findIndex(x=>x.id===t.id); tasks[i]=payload; }
      else { tasks.unshift(payload); }
      // atualiza colabs
      payload.collabs.forEach(c=>{ if(c && !collabs.includes(c)) collabs.push(c); });
      localStorage.setItem('dipe_collabs', JSON.stringify(collabs));
      persist(); buildFilters(); render(); wrap.remove();
    };
    panel.querySelector('#btnDel').onclick = ()=>{ if(t && confirm('Excluir esta tarefa?')){ tasks = tasks.filter(x=>x.id!==t.id); persist(); render(); wrap.remove(); } };
  }

  // ===== MODAIS: CLIENTES & COLABS =====
  function openClients(){
    const tpl=$('#tplClients').content.cloneNode(true); const panel=tpl.querySelector('.panel');
    const wrap=document.createElement('section'); wrap.id='modal'; wrap.style='position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:50'; wrap.appendChild(panel); document.body.appendChild(wrap);
    const list=panel.querySelector('#clientsList');
    function row(c){ const r=document.createElement('div'); r.className='row'; r.style.gap='8px'; r.innerHTML=`<input placeholder="Nome" value="${c?.name||''}" style="flex:1"><input type="color" value="${c?.color||'#888888'}" style="width:100px"><button class="btn ghost">üóëÔ∏è</button>`; r.querySelector('button').onclick=()=> r.remove(); return r; }
    clients.forEach(c=> list.appendChild(row(c)));
    panel.querySelector('#btnAddClient').onclick=()=> list.appendChild(row({name:'',color:'#888888'}));
    panel.querySelector('#btnSaveClients').onclick=()=>{
      clients = Array.from(list.querySelectorAll('.row')).map(r=>{ const name=r.querySelector('input[type="text"]').value.trim(); const color=r.querySelector('input[type="color"]').value; if(!name) return null; const text = contrast(color); return {name, color, text}; }).filter(Boolean);
      localStorage.setItem('dipe_clients', JSON.stringify(clients)); buildFilters(); render(); wrap.remove();
    };
    wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
  }
  function openCollabs(){
    const tpl=$('#tplCollabs').content.cloneNode(true); const panel=tpl.querySelector('.panel');
    const wrap=document.createElement('section'); wrap.id='modal'; wrap.style='position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:50'; wrap.appendChild(panel); document.body.appendChild(wrap);
    const list=panel.querySelector('#collabsList');
    function row(name){ const r=document.createElement('div'); r.className='row'; r.style.gap='8px'; r.innerHTML=`<input placeholder="Nome do colaborador" value="${name||''}" style="flex:1"><button class="btn ghost">üóëÔ∏è</button>`; r.querySelector('button').onclick=()=> r.remove(); return r; }
    collabs.forEach(c=> list.appendChild(row(c)));
    panel.querySelector('#btnAddCollab').onclick=()=> list.appendChild(row(''));
    panel.querySelector('#btnSaveCollabs').onclick=()=>{ collabs = Array.from(list.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean); localStorage.setItem('dipe_collabs', JSON.stringify(collabs)); buildFilters(); render(); wrap.remove(); };
    wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
  }

  // ===== A√á√ïES TOPO & LOGIN =====
  function showApp(){ document.getElementById('login').classList.add('hidden'); document.getElementById('appHeader').classList.remove('hidden'); document.getElementById('app').classList.remove('hidden'); load(); }
  function showLogin(){ document.getElementById('login').classList.remove('hidden'); document.getElementById('appHeader').classList.add('hidden'); document.getElementById('app').classList.add('hidden'); }

  // binds principais (robustos)
  document.getElementById('btnEnter').addEventListener('click', ()=>{
    const v=document.getElementById('pass').value.trim();
    if(v===PANEL_PASS){ sessionStorage.setItem('dipe_ok','1'); document.getElementById('loginMsg').textContent=''; showApp(); }
    else{ document.getElementById('loginMsg').textContent='Senha incorreta'; }
  });
  document.getElementById('pass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('btnEnter').click(); });

  document.getElementById('btnNew').addEventListener('click', ()=> openTask(null));
  document.getElementById('btnClients').addEventListener('click', openClients);
  document.getElementById('btnCollabs').addEventListener('click', openCollabs);
  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  document.getElementById('btnLock').addEventListener('click', ()=>{ sessionStorage.removeItem('dipe_ok'); location.reload(); });

  document.getElementById('btnExportCsv').addEventListener('click', ()=>{
    const arr = filtered(); const head=['id','title','client','collabs','status','date','desc','updated'];
    const rows=[head.join(',')].concat(arr.map(t=>[t.id,t.title,t.client,(t.collabs||[]).join('|'),t.status,t.date,t.desc,t.updated].map(csvEscape).join(',')));
    const blob=new Blob([rows.join('
')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tarefas.csv'; a.click();
  });
  document.getElementById('btnExportJson').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(filtered(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tarefas.json'; a.click();
  });
  document.getElementById('importJson').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return; const text=await file.text(); let data=[]; try{ data=JSON.parse(text); }catch(err){ alert('JSON inv√°lido'); return; }
    if(!Array.isArray(data)){ alert('Esperado um array de tarefas'); return; }
    if(!confirm('Importar '+data.length+' tarefas?')) return;
    for(const x of data){ tasks.push({ id: uid(), title:x.title||'Sem t√≠tulo', client:x.client||clients[0]?.name||'Cliente', status:x.status||'A Fazer', date:x.date||null, collabs:x.collabs||[], desc:x.desc||'', updated:new Date().toISOString() }); }
    persist(); render(); e.target.value='';
  });

  // filtros
  ['q','fClient','fCollab','fStatus','fDate'].forEach(id=> document.getElementById(id).addEventListener('input', render));
  document.getElementById('btnClear').addEventListener('click', ()=>{ ['q','fClient','fCollab','fStatus','fDate'].forEach(id=>{const el=document.getElementById(id); el.value='';}); render(); });

  // start
  if(sessionStorage.getItem('dipe_ok')) showApp(); else showLogin();
  buildFilters(); render();
  </script>
</body>
</html>
