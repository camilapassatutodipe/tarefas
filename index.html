<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Dipe — Diário • Semanal • Entregas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Paleta Dipe */
      --bg:#1b1b18;           /* fundo/header */
      --paper:#f5f4ea;        /* superfície */
      --muted:#e7e6de;        /* bordas suaves */
      --ink:#1b1b18;          /* texto principal */
      --accent:#ff573b;       /* botões e foco */
      --accent-ink:#fff;

      /* Cores por cliente (ajustáveis) */
      --matec:#02d1ce;        /* azul piscina */
      --construcione:#000000; /* preto */
      --vertticom:#d67a59;    /* terracota sugerida */
      --lrocha:#7b1e2b;       /* vermelho vinho */

      --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --todo:#d6d3d1; --doing:#60a5fa; --done:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Roboto, system-ui, -apple-system, Segoe UI, Arial; color:var(--ink); background:linear-gradient(180deg,#fbfaf5 0%, #f2f1ea 100%)}

    /* Header */
    .bar{position:sticky; top:0; z-index:20; background:var(--bg); color:#fff; border-bottom:1px solid rgba(255,255,255,.08)}
    .bar-inner{max-width:1300px; margin:0 auto; padding:14px 18px; display:flex; gap:16px; align-items:center}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .brand-badge{width:28px; height:28px; display:grid; place-items:center; border-radius:8px; background:var(--accent); color:var(--accent-ink); font-size:14px}
    .seg{display:flex; gap:10px; align-items:center; margin-left:auto}

    /* Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{appearance:none; border:1px solid rgba(255,255,255,.18); color:#fff; background:transparent; padding:8px 12px; border-radius:12px; cursor:pointer}
    .tab.active{background:#fff; color:var(--bg); border-color:#fff}

    /* Toolbar */
    .toolbar{max-width:1300px; margin:14px auto 0; padding:0 18px 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; background:#fff; border:1px solid var(--muted); box-shadow:var(--shadow)}
    .chip input, .chip select{border:none; outline:none; font:inherit; background:transparent}
    .icon{opacity:.7}
    .btn{appearance:none; border:none; background:var(--accent); color:var(--accent-ink); padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); font-weight:600}
    .btn.secondary{background:#fff; color:var(--ink); border:1px solid var(--muted)}
    .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--muted)}

    /* Stats */
    .stats{max-width:1300px; margin:0 auto; padding:0 18px 16px; display:grid; grid-template-columns:repeat(6,1fr); gap:12px}
    .stat{background:#fff; border:1px solid var(--muted); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
    .stat h4{margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.12em; color:#666}
    .stat .v{font-size:20px; font-weight:700}

    /* Boards */
    .wrap{max-width:1300px; margin:0 auto; padding:0 18px 28px}
    .board{display:grid; gap:16px}
    .board.daily{grid-template-columns:repeat(3,1fr)}
    .board.weekly{grid-template-columns:repeat(7, 1fr)}

    .col{background:#fff; border:1px solid var(--muted); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; min-height:240px}
    .col-head{padding:12px 14px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--muted); background:linear-gradient(180deg,#ffffff 0,#fbfbfb 100%)}
    .col-title{font-weight:700; display:flex; gap:8px; align-items:center}
    .drop{flex:1; padding:10px; min-height:160px}

    /* Cards */
    .card{background:#fff; border:1px solid var(--muted); border-radius:12px; padding:10px; margin:10px 6px; box-shadow:var(--shadow); cursor:grab}
    .card.dragging{opacity:.5}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; border:1px solid rgba(0,0,0,.08)}
    .tag .dot{width:8px; height:8px; border-radius:999px}
    .meta{display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin-top:8px}
    .avatars{display:flex}
    .avatar{width:22px;height:22px;border-radius:999px;display:grid;place-items:center; font-size:11px; font-weight:700; color:#fff; margin-right:-6px; border:2px solid #fff}
    .badge{font-size:11px; padding:2px 6px; border-radius:999px; background:#f3f3f0; border:1px solid var(--muted)}

    /* Table (Entregas) */
    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{padding:12px; border-bottom:1px solid var(--muted); text-align:left}
    thead th{position:sticky; top:0; background:#fff; z-index:1}
    tbody tr:hover{background:#faf9f4}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.show{display:flex}
    .sheet{width:min(680px,92vw); background:#fff; border-radius:20px; box-shadow:0 30px 60px rgba(0,0,0,.25); overflow:hidden}
    .sheet-h{display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-bottom:1px solid var(--muted)}
    .sheet-b{padding:18px}
    .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .grid .full{grid-column:1/-1}
    label{font-size:12px; color:#666}
    input[type="text"], input[type="date"], textarea, select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--muted); background:#fff; font:inherit; resize:vertical}

    /* Helpers */
    .hidden{display:none}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid var(--muted); background:#fff}
    .divider{height:1px; background:var(--muted); margin:10px 0}

    /* Responsive */
    @media (max-width:1100px){
      .stats{grid-template-columns:repeat(3,1fr)}
    }
    @media (max-width:800px){
      .board.daily{grid-template-columns:1fr}
      .board.weekly{grid-template-columns:repeat(2,1fr)}
      .grid{grid-template-columns:1fr}
      .seg{flex-wrap:wrap}
    }
  </style>
  
  <!-- Gate de senha (básico) -->
  <style>
    html.locked body{overflow:hidden}
    #lockscreen{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg,#1b1b18 0,#2a2a26 100%); z-index:9999 }
    #lockscreen .panel{ width:min(420px,92vw); background:#fff; border-radius:16px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.4) }
    #lockscreen h1{margin:0 0 10px; font-size:18px}
    #lockscreen label{font-size:12px; color:#666}
    #lockscreen input[type=password]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #ddd; font:inherit; margin:8px 0 12px}
    #lockscreen .btn{appearance:none; border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    #lockscreen .error{color:#b91c1c; font-size:12px; min-height:18px}
  </style>
  <script>document.documentElement.classList.add('locked');</script>
  
  <!-- Supabase JS (para multiusuário e tempo real) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Tela de senha -->
  <div id="lockscreen" role="dialog" aria-modal="true" aria-labelledby="ls-title">
    <div class="panel">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <div class="brand-badge">D</div>
        <div><strong>Agência Dipe</strong><div style="font-size:12px;opacity:.7">Acesso restrito</div></div>
      </div>
      <h1 id="ls-title">Digite a senha</h1>
      <form id="lock-form">
        <label for="lock-pass">Senha</label>
        <input type="password" id="lock-pass" placeholder="••••••••" required />
        <div style="display:flex;align-items:center;gap:8px;margin:0 0 12px">
          <input type="checkbox" id="lock-remember" />
          <label for="lock-remember">Lembrar por 7 dias neste dispositivo</label>
        </div>
        <div class="error" id="lock-error"></div>
        <button class="btn" type="submit">Entrar</button>
      </form>
    </div>
  </div>
  <!-- Header / Tabs -->
  <header class="bar" role="banner">
    <div class="bar-inner">
      <div class="brand" title="Agência Dipe | Painel de tarefas">
        <div class="brand-badge">D</div>
        <div>
          <div style="font-size:14px; opacity:.8">Agência Dipe</div>
          <div style="font-size:13px; opacity:.6">Painel diário • semanal • entregas</div>
        </div>
      </div>
      <nav class="tabs" aria-label="Vistas">
        <button class="tab active" data-view="daily">Diário</button>
        <button class="tab" data-view="weekly">Semanal</button>
        <button class="tab" data-view="deliveries">Entregas</button>
      </nav>
      $1
        <button class="btn secondary" id="btnNewTask">+ Nova tarefa</button>
        <button class="btn secondary" id="btnExportCsv" title="Baixar CSV das tarefas">Exportar CSV</button>
        <button class="btn secondary" id="btnExportJson" title="Baixar backup JSON">Backup JSON</button>
        <label class="btn ghost" for="importFile" title="Importar JSON"><input type="file" id="importFile" accept="application/json" style="display:none">Importar</label>
        <button class="btn" id="btnPrint">Imprimir relatório</button>
        <button class="btn secondary" id="btnSBLogin" title="Entrar para sincronizar com a equipe">Entrar (time)</button>
        <button class="btn ghost hidden" id="btnSBLogout" title="Sair da conta da equipe">Sair (time)</button>
        <button class="btn ghost" id="btnLogout" title="Bloquear esta página">Bloquear página</button>
      $2
    </div>

    <!-- Toolbar (filtros) -->
    <div class="toolbar" role="region" aria-label="Filtros e pesquisa">
      <div class="chip" title="Pesquisa">
        <span class="icon">🔎</span>
        <input type="text" id="q" placeholder="Pesquisar título/descrição…" />
      </div>
      <div class="chip" title="Cliente">
        <span>Cliente</span>
        <select id="filterClient">
          <option value="">Todos</option>
          <option value="Matec">Matec</option>
          <option value="Construcione">Construcione</option>
          <option value="Vertticom">Vertticom</option>
          <option value="LRocha">LRocha</option>
        </select>
      </div>
      <div class="chip" title="Colaborador">
        <span>Colaborador</span>
        <select id="filterCollab"><option value="">Todos</option></select>
      </div>
      <div class="chip" title="Status">
        <span>Status</span>
        <select id="filterStatus">
          <option value="">Todos</option>
          <option>Backlog</option>
          <option>A Fazer</option>
          <option>Em Progresso</option>
          <option>Concluído</option>
        </select>
      </div>
      <div class="chip" id="dateGroupDaily">
        <span>Dia</span>
        <input type="date" id="dateDaily" />
      </div>
      <div class="chip hidden" id="dateGroupWeekly">
        <span>Semana</span>
        <input type="date" id="dateWeekly" title="Escolha um dia da semana"/>
        <button class="btn ghost" id="btnThisWeek">Esta semana</button>
      </div>
      <div class="chip" title="Limpar filtros">
        <button class="btn ghost" id="btnClear">Limpar</button>
      </div>
    </div>
  </header>

  <!-- Stats -->
  <section class="stats" aria-label="Indicadores rápidos">
    <div class="stat"><h4>Hoje</h4><div class="v" id="statToday">0</div></div>
    <div class="stat"><h4>Semana</h4><div class="v" id="statWeek">0</div></div>
    <div class="stat"><h4>Backlog</h4><div class="v" id="statBacklog">0</div></div>
    <div class="stat"><h4>Em progresso</h4><div class="v" id="statDoing">0</div></div>
    <div class="stat"><h4>Concluído (semana)</h4><div class="v" id="statDone">0</div></div>
    <div class="stat"><h4>Clientes ativos</h4><div class="v" id="statClients">0</div></div>
  </section>

  <main class="wrap">
    <!-- Board Diário -->
    <section id="view-daily" class="board daily" aria-label="Quadro Diário">
      <div class="col" data-status="A Fazer">
        <div class="col-head"><div class="col-title">🗂️ A Fazer</div><span class="badge" id="count_todo">0</span></div>
        <div class="drop" data-drop="daily"></div>
      </div>
      <div class="col" data-status="Em Progresso">
        <div class="col-head"><div class="col-title">⚙️ Em Progresso</div><span class="badge" id="count_doing">0</span></div>
        <div class="drop" data-drop="daily"></div>
      </div>
      <div class="col" data-status="Concluído">
        <div class="col-head"><div class="col-title">✅ Concluído</div><span class="badge" id="count_done">0</span></div>
        <div class="drop" data-drop="daily"></div>
      </div>
    </section>

    <!-- Board Semanal -->
    <section id="view-weekly" class="board weekly hidden" aria-label="Quadro Semanal"></section>

    <!-- Entregas (tabela) -->
    <section id="view-deliveries" class="hidden" aria-label="Lista de Entregas">
      <div class="col" style="padding:0">
        <div class="col-head"><div class="col-title">📦 Entregas & Tarefas</div><div class="col-actions"><button class="btn ghost" id="btnNewWeek">Iniciar semana limpa</button></div></div>
        <div class="drop" style="padding:0">
          <table id="tbl">
            <thead>
              <tr>
                <th>Título</th>
                <th>Cliente</th>
                <th>Colaboradores</th>
                <th>Status</th>
                <th>Dia</th>
                <th>Últ. alteração</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Nova/Editar Tarefa -->
  <div class="modal" id="taskModal" aria-hidden="true" aria-labelledby="taskTitle">
    <div class="sheet">
      <div class="sheet-h">
        <strong id="taskModalTitle">Nova tarefa</strong>
        <div>
          <button class="btn ghost" id="btnDeleteTask" title="Excluir">Excluir</button>
          <button class="btn" id="btnSaveTask">Salvar</button>
        </div>
      </div>
      <div class="sheet-b">
        <div class="grid">
          <div class="full">
            <label for="f_title">Título</label>
            <input type="text" id="f_title" placeholder="Ex.: Post LinkedIn Matec — Junho Vermelho" required>
          </div>
          <div>
            <label for="f_client">Cliente</label>
            <select id="f_client">
              <option>Matec</option>
              <option>Construcione</option>
              <option>Vertticom</option>
              <option>LRocha</option>
            </select>
          </div>
          <div>
            <label for="f_status">Status</label>
            <select id="f_status">
              <option>Backlog</option>
              <option selected>A Fazer</option>
              <option>Em Progresso</option>
              <option>Concluído</option>
            </select>
          </div>
          <div>
            <label for="f_date">Dia</label>
            <input type="date" id="f_date">
          </div>
          <div>
            <label for="f_collabs">Colaboradores (separe por vírgula)</label>
            <input type="text" id="f_collabs" placeholder="Ex.: Camila, Alinne">
          </div>
          <div class="full">
            <label for="f_desc">Descrição</label>
            <textarea id="f_desc" rows="4" placeholder="Detalhes, critérios de aceite, links…"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
(function(){
  // sha256("dipe2025!") — troque o hash para mudar a senha
  const PASS_HASH = "9c1be30472290f574e714090b73254428bd5c557c9a504349c7cf38ecb3c0681";
  const KEY_SESSION = "dipe_auth";
  const KEY_UNTIL   = "dipe_auth_until";
  async function sha256(s){
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(s));
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function unlock(){
    document.documentElement.classList.remove("locked");
    const ls = document.getElementById("lockscreen"); if(ls) ls.remove();
    window.__unlocked = true;
  }
  const until = parseInt(localStorage.getItem(KEY_UNTIL)||"0",10);
  if (sessionStorage.getItem(KEY_SESSION)==="ok" || (until && Date.now()<until)) {
    unlock();
  } else {
    window.addEventListener("DOMContentLoaded", ()=>{
      const ls = document.getElementById("lockscreen"); if(ls) ls.style.display = "flex";
      const form = document.getElementById("lock-form");
      if(form) form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const pwd = document.getElementById("lock-pass").value;
        const remember = document.getElementById("lock-remember").checked;
        const hash = await sha256(pwd);
        if(hash === PASS_HASH){
          sessionStorage.setItem(KEY_SESSION,"ok");
          if(remember){ localStorage.setItem(KEY_UNTIL, String(Date.now()+7*24*60*60*1000)); }
          unlock();
        } else {
          const err = document.getElementById("lock-error"); if(err) err.textContent = "Senha incorreta";
        }
      });
    });
  }
  window.logout = function(){ sessionStorage.removeItem(KEY_SESSION); localStorage.removeItem(KEY_UNTIL); location.reload(); };
})();
</script>

<script>
// === SUPABASE — Configuração e helpers ===
const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co'; // <-- cole aqui
const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';               // <-- cole aqui
const TEAM = 'dipe';
const sb = (typeof supabase !== 'undefined') ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
let isAuthed = false, rtChannel = null;

function toggleAuthBtns(on){
  const inBtn = document.getElementById('btnSBLogin');
  const outBtn = document.getElementById('btnSBLogout');
  if(!inBtn||!outBtn) return;
  inBtn.classList.toggle('hidden', !!on);
  outBtn.classList.toggle('hidden', !on);
}

async function bootAuth(){
  if(!sb) return;
  const { data:{ session } } = await sb.auth.getSession();
  isAuthed = !!session; toggleAuthBtns(isAuthed);
  if(isAuthed){ await syncFromDB(); setupRealtime(); }
  sb.auth.onAuthStateChange(async (_evt, session)=>{
    isAuthed = !!session; toggleAuthBtns(isAuthed);
    if(isAuthed){ await syncFromDB(); setupRealtime(); } else { if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }
  });
  document.getElementById('btnSBLogin')?.addEventListener('click', async ()=>{
    const email = prompt('Digite seu e-mail para receber o link de acesso:');
    if(!email) return;
    const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href } });
    alert(error ? ('Erro: '+error.message) : 'Enviamos um link de acesso para seu e-mail.');
  });
  document.getElementById('btnSBLogout')?.addEventListener('click', async ()=>{ await sb.auth.signOut(); });
}

async function syncFromDB(){
  if(!sb) return;
  const { data, error } = await sb.from('tasks').select('*').eq('team', TEAM).order('updated', { ascending:false });
  if(error){ console.error(error); return; }
  state.tasks = data||[];
  state.collabs = Array.from(new Set(state.tasks.flatMap(t=>t.collabs||[])));
  document.getElementById('filterCollab').innerHTML = '<option value="">Todos</option>' + state.collabs.map(c=>`<option>${c}</option>`).join('');
  render();
}

function setupRealtime(){
  if(!sb) return; if(rtChannel){ sb.removeChannel(rtChannel); }
  rtChannel = sb.channel('public:tasks').on('postgres_changes', { event:'*', schema:'public', table:'tasks' }, (payload)=>{
    const row = payload.new || payload.old; if(!row || row.team!==TEAM) return;
    if(payload.eventType==='INSERT' || payload.eventType==='UPDATE'){
      const i = state.tasks.findIndex(x=>x.id===row.id); if(i>=0) state.tasks[i]=row; else state.tasks.unshift(row);
    } else if(payload.eventType==='DELETE'){
      state.tasks = state.tasks.filter(x=>x.id!==row.id);
    }
    state.collabs = Array.from(new Set(state.tasks.flatMap(t=>t.collabs||[])));
    document.getElementById('filterCollab').innerHTML = '<option value="">Todos</option>' + state.collabs.map(c=>`<option>${c}</option>`).join('');
    render();
  }).subscribe();
}

async function dbInsert(t){
  const payload = { title:t.title, client:t.client, status:t.status, date: t.date||null, collabs:t.collabs, desc:t.desc, team: TEAM };
  const { data, error } = await sb.from('tasks').insert(payload).select().single();
  if(error){ alert('Erro ao salvar: '+error.message); return null; }
  return data;
}
async function dbUpdate(t){
  const payload = { title:t.title, client:t.client, status:t.status, date: t.date||null, collabs:t.collabs, desc:t.desc, updated: new Date().toISOString() };
  const { data, error } = await sb.from('tasks').update(payload).eq('id', t.id).select().single();
  if(error){ alert('Erro ao atualizar: '+error.message); return null; }
  return data;
}
async function dbDelete(id){
  const { error } = await sb.from('tasks').delete().eq('id', id);
  if(error){ alert('Erro ao excluir: '+error.message); }
}

bootAuth();
</script>

$1
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const fmtDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR') : '';
  const todayISO = () => new Date().toISOString().slice(0,10);
  const mondayOf = (iso) => { const d=new Date(iso||todayISO()); const day = (d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10)}; // segunda
  const addDays = (iso, n) => { const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10)};
  const uid = () => (crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)}));

  // ===== Estado =====
  const STORAGE_KEY = 'dipe_board_v1';
  let state = load() || { tasks: [], collabs: ['Camila','Alinne'], last: Date.now() };
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null } }

  // ===== Clientes / Cores =====
  const CLIENTS = {
    Matec: { color: getComputedStyle(document.documentElement).getPropertyValue('--matec').trim(), text:'#0a0a0a' },
    Construcione: { color: getComputedStyle(document.documentElement).getPropertyValue('--construcione').trim(), text:'#ffffff' },
    Vertticom: { color: getComputedStyle(document.documentElement).getPropertyValue('--vertticom').trim(), text:'#ffffff' },
    LRocha: { color: getComputedStyle(document.documentElement).getPropertyValue('--lrocha').trim(), text:'#ffffff' }
  };

  // ===== Init UI =====
  const dateDaily = $('#dateDaily');
  const dateWeekly = $('#dateWeekly');
  dateDaily.value = todayISO();
  dateWeekly.value = todayISO();
  $('#filterCollab').innerHTML = '<option value="">Todos</option>' + state.collabs.map(c=>`<option>${c}</option>`).join('');

  // Tabs
  $$('.tab').forEach(t=> t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const v = t.dataset.view;
    $('#view-daily').classList.toggle('hidden', v!=='daily');
    $('#view-weekly').classList.toggle('hidden', v!=='weekly');
    $('#view-deliveries').classList.toggle('hidden', v!=='deliveries');
    $('#dateGroupDaily').classList.toggle('hidden', v!=='daily');
    $('#dateGroupWeekly').classList.toggle('hidden', v!=='weekly');
    render();
  }));

  // Botões topo
  $('#btnNewTask').addEventListener('click', ()=> openTaskModal());
  $('#btnExportCsv').addEventListener('click', exportCSV);
  $('#btnExportJson').addEventListener('click', exportJSON);
  $('#btnPrint').addEventListener('click', ()=> window.print());
  $('#btnClear').addEventListener('click', ()=>{ $('#q').value=''; $('#filterClient').value=''; $('#filterCollab').value=''; $('#filterStatus').value=''; render(); })
  $('#btnThisWeek').addEventListener('click', ()=>{ dateWeekly.value = todayISO(); render(); })
  $('#btnNewWeek').addEventListener('click', startCleanWeek);
  $('#importFile').addEventListener('change', importJSON);
  document.getElementById('btnLogout')?.addEventListener('click', ()=>{ if(confirm('Sair da sessão?')) window.logout(); });

  // Filtros
  ;['q','filterClient','filterCollab','filterStatus','dateDaily','dateWeekly'].forEach(id=>{
    document.getElementById(id).addEventListener('input', render)
  })

  // ===== CRUD Tarefas =====
  function openTaskModal(task){
    const m = $('#taskModal');
    m.classList.add('show');
    m.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';

    $('#btnDeleteTask').style.display = task? 'inline-flex':'none';
    $('#taskModalTitle').textContent = task? 'Editar tarefa' : 'Nova tarefa';

    // Preencher
    $('#f_title').value = task?.title || '';
    $('#f_client').value = task?.client || 'Matec';
    $('#f_status').value = task?.status || 'A Fazer';
    $('#f_date').value = task?.date || todayISO();
    $('#f_collabs').value = (task?.collabs||[]).join(', ');
    $('#f_desc').value = task?.desc || '';

    const close = (e)=>{ if(e.target===m) hide() };
    m.addEventListener('click', close, { once:true });

    $('#btnSaveTask').onclick = async () => {
      const t = {
        id: task?.id || undefined,
        title: $('#f_title').value.trim(),
        client: $('#f_client').value,
        status: $('#f_status').value,
        date: $('#f_date').value,
        collabs: $('#f_collabs').value.split(',').map(s=>s.trim()).filter(Boolean),
        desc: $('#f_desc').value.trim(),
        updated: Date.now()
      };
      if(!t.title) { alert('Dê um título à tarefa.'); return }
      t.collabs.forEach(c=>{ if(!state.collabs.includes(c)) state.collabs.push(c) });
      document.getElementById('filterCollab').innerHTML = '<option value="">Todos</option>' + state.collabs.map(c=>`<option>${c}</option>`).join('');

      if(isAuthed && sb){
        if(t.id){
          const row = await dbUpdate(t); if(row){ const i=state.tasks.findIndex(x=>x.id===row.id); if(i>=0) state.tasks[i]=row; else state.tasks.unshift(row); }
        } else {
          const row = await dbInsert(t); if(row){ state.tasks.unshift(row); }
        }
      } else {
        if(!t.id) t.id = uid();
        const idx = state.tasks.findIndex(x=>x.id===t.id);
        if(idx>=0) state.tasks[idx]=t; else state.tasks.push(t);
        save();
      }
      render(); hide();
    };
    $('#btnDeleteTask').onclick = async () => {
      if(task && confirm('Excluir esta tarefa?')){
        if(isAuthed && sb){ await dbDelete(task.id); } else {
          state.tasks = state.tasks.filter(x=>x.id!==task.id); save();
        }
        render(); hide();
      }
    }
      drop.ondragleave = ()=> drop.style.background='';
      drop.ondrop = (e)=>{
        e.preventDefault(); drop.style.background='';
        const id = e.dataTransfer.getData('text/plain');
        const task = state.tasks.find(t=>t.id===id); if(!task) return;
        const parentCol = drop.closest('.col');
        if(drop.dataset.drop==='daily'){
          // Mudar status para coluna atual e dia = selecionado
          task.status = parentCol.dataset.status;
          task.date = $('#dateDaily').value || todayISO();
        }else{
          // Semanal: mover para o dia
          task.date = parentCol.dataset.day;
        }
        task.updated = Date.now(); save(); render();
      }
    })
  }

  function renderCards(container, items, mode){
    for(const t of items){ container.appendChild(cardHTML(t, mode)); }
  }

  function cardHTML(t, mode){
    const card = document.createElement('article');
    card.className='card'; card.draggable=true; card.id = 'card_'+t.id; card.dataset.id = t.id;
    card.addEventListener('dragstart', (e)=>{ card.classList.add('dragging'); e.dataTransfer.setData('text/plain', t.id) });
    card.addEventListener('dragend', ()=> card.classList.remove('dragging'));
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:8px; align-items:flex-start;">
        <div style="flex:1; min-width:0">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px">
            ${clientTag(t.client)}
            ${t.status==='Backlog'?'<span class="badge">Backlog</span>':''}
          </div>
          <div style="font-weight:700; line-height:1.35">${escapeHtml(t.title)}</div>
          ${t.desc?`<div style="opacity:.75; font-size:12px; margin-top:4px">${escapeHtml(t.desc)}</div>`:''}
        </div>
        <button class="btn ghost" style="padding:6px 8px" data-quickedit="${t.id}" title="Editar">✏️</button>
      </div>
      <div class="meta">
        <div class="avatars">${(t.collabs||[]).map(c=>avatarHTML(c)).join('')}</div>
        ${mode==='weekly'?`<span class="badge">${fmtDate(t.date||'')}</span>`:''}
      </div>`;
    // click -> editar
    $('[data-quickedit]', card).addEventListener('click', ()=> openTaskModal(t));
    return card;
  }

  function clientTag(name){
    const c = CLIENTS[name]||{color:'#999', text:'#111'};
    const style = `background:${c.color}; color:${c.text}`;
    return `<span class="tag" style="${style}"><span class="dot" style="background:#fff; opacity:.9"></span>${name}</span>`
  }

  function avatarHTML(name){
    const initials = (name||'?').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
    const hue = [...(name||'a')].reduce((a,c)=>a+c.charCodeAt(0),0)%360;
    const bg = `hsl(${hue} 60% 40%)`;
    return `<span class="avatar" title="${name}" style="background:${bg}">${initials}</span>`
  }

  function renderStats(list){
    const day = $('#dateDaily').value || todayISO();
    const anyDay = $('#dateWeekly').value || todayISO();
    const mon = mondayOf(anyDay); const sun = addDays(mon,6);
    const inWeek = list.filter(t=> t.date && t.date>=mon && t.date<=sun);

    $('#statToday').textContent = list.filter(t=>t.date===day && t.status!=='Backlog').length;
    $('#statWeek').textContent = inWeek.length;
    $('#statBacklog').textContent = list.filter(t=>t.status==='Backlog').length;
    $('#statDoing').textContent = list.filter(t=>t.status==='Em Progresso').length;
    $('#statDone').textContent = inWeek.filter(t=>t.status==='Concluído').length;
    $('#statClients').textContent = new Set(list.map(t=>t.client)).size;
  }

  // ===== Export / Import =====
  function exportCSV(){
    const list = filteredTasks();
    const cols = ['id','titulo','cliente','colaboradores','status','data','descricao','atualizado_em'];
    const csv = [cols.join(';')].concat(list.map(t=>[
      t.id,
      escCSV(t.title),
      t.client,
      escCSV((t.collabs||[]).join(',')),
      t.status,
      t.date||'',
      escCSV(t.desc||''),
      new Date(t.updated||Date.now()).toLocaleString('pt-BR')
    ].join(';'))).join('\n');
    download(csv, `dipe-relatorio-${Date.now()}.csv`, 'text/csv');
  }
  function exportJSON(){ download(JSON.stringify(state,null,2), `dipe-backup-${Date.now()}.json`, 'application/json') }
  function importJSON(e){
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(!data.tasks) throw new Error('Arquivo inválido');
        state = data; save(); $('#filterCollab').innerHTML = '<option value="">Todos</option>' + state.collabs.map(c=>`<option>${c}</option>`).join(''); render();
        alert('Importação concluída!');
      }catch(err){ alert('Falha ao importar: '+err.message) }
    };
    reader.readAsText(f);
  }
  function download(content, filename, mime){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  // ===== Semana limpa =====
  function startCleanWeek(){
    if(!confirm('Criar semana limpa (mantém backlog, remove datas e status de concluído)?')) return;
    state.tasks = state.tasks.map(t=>{
      if(t.status==='Concluído'){ return t } // mantém histórico concluído
      return { ...t, date:'', status: t.status==='Backlog' ? 'Backlog' : 'A Fazer', updated: Date.now() };
    });
    save(); render();
  }

  // ===== Helpers =====
  function escCSV(s){ return '"'+String(s).replaceAll('"','""')+'"' }
  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

  // ===== Semeadura opcional =====
  if(state.tasks.length===0){
    // Comece vazio; se quiser, descomente a seguir para exemplos
    // state.tasks.push({id:uid(), title:'Exemplo — Post LinkedIn', client:'Matec', status:'A Fazer', date:todayISO(), collabs:['Camila'], desc:'Legenda + arte', updated:Date.now()});
    save();
  }

  // Estado inicial — render
  render();
  </script>
</body>
</html>
